---
title: "Section E"
subtitle: "https://dcsuh.github.io/mappingInR/"
author: "Daniel Suh"
date: "11/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sf)  
library(terra)  
library(tidyverse)  
library(spData)
library(spDataLarge)
library(magrittr)

library(tmap)    # for static and interactive maps
library(leaflet) # for interactive maps
library(ggplot2) # tidyverse data visualization package
```


## Making Maps with R

Time to make some maps. We'll focus on the 'tmap' package here, but there are a number of packages dedicated to making maps. We'll also introduce 'leaflet' and the mapping capabilites of 'ggplot2'. First, we will go over static maps and then move on to dynamic and interactive maps.

## Static Maps

Static maps are the most common result when visualizing spatial data. Base R's plot() can be used for static maps as we've demonstrated throughout the workshop. However, 'tmap' offers more options for aesthetics and follows a similar syntax with ggplot.

## tmap

Like ggplot, tmap follows a 'grammar of graphics' (the gg in ggplot), where input data is separated from the aesthetics. Input data is defined using tm_shape() and aesthetics are layered on using a wide variety of functions such as tm_fill() and tm_dots().

```{r}
# Add fill layer to nz shape
tm_shape(nz) +
  tm_fill() 
# Add border layer to nz shape
tm_shape(nz) +
  tm_borders() 
# Add fill and border layers to nz shape
tm_shape(nz) +
  tm_fill() +
  tm_borders() 
```

Play around with tmap. Type help("tmap-element") into your console for a full list of functions.

## Map objects

A useful feature of tmap is its ability to store objects representing maps. 

```{r}
map_nz <- tm_shape(nz) + tm_polygons()
class(map_nz)
```

Storing maps as map objects is useful for adding aesthetic layers and new spatial objects on top of each other. You can now add layers to 'map_nz' by simply using the + operator. If you add + tm_shape() then you can add another spatial object.

```{r}
map_nz1 = map_nz +
  tm_shape(nz_elev) + tm_raster(alpha = 0.7)
```

```{r}
nz_water = st_union(nz) %>% st_buffer(22200) %>% 
  st_cast(to = "LINESTRING")
map_nz2 = map_nz1 +
  tm_shape(nz_water) + tm_lines()
```

```{r}
map_nz3 = map_nz2 +
  tm_shape(nz_height) + tm_dots()
```

```{r}
tmap_arrange(map_nz1, map_nz2, map_nz3)
```


## Aesthetics

Like ggplot, the default aesthetics of each layer can be changed. Unlike ggplot, tmap does not use the aes() function but layers can accept arguments that are fixed values or variable fields (based on column names). 

Here is an example of fixed values
```{r}
ma1 = tm_shape(nz) + tm_fill(col = "red")
ma2 = tm_shape(nz) + tm_fill(col = "red", alpha = 0.3)
ma3 = tm_shape(nz) + tm_borders(col = "blue")
ma4 = tm_shape(nz) + tm_borders(lwd = 3)
ma5 = tm_shape(nz) + tm_borders(lty = 2)
ma6 = tm_shape(nz) + tm_fill(col = "red", alpha = 0.3) +
  tm_borders(col = "blue", lwd = 3, lty = 2)
tmap_arrange(ma1, ma2, ma3, ma4, ma5, ma6)
```

And here is an example of how you would use values from a variable. The argument will take the character string associated with the column you are interested in.
```{r}
tm_shape(nz) + tm_fill(col = "Land_area")
```

Finally, you can add nicer titles. expression() allows for superscripts

```{r}
legend_title = expression("Area (km"^2*")")
map_nza = tm_shape(nz) +
  tm_fill(col = "Land_area", title = legend_title) + tm_borders()
map_nza
```

## Color settings

Colors are useful. Here are a few ways to manipulate color in your maps. Play around and figure out what each of these arguments (breaks, n, palette) do.

```{r}
col1 <- tm_shape(nz) + tm_polygons(col = "Median_income")
breaks <- c(0, 3, 4, 5) * 10000
col2 <- tm_shape(nz) + tm_polygons(col = "Median_income", breaks = breaks)
col3 <- tm_shape(nz) + tm_polygons(col = "Median_income", n = 10)
col4 <- tm_shape(nz) + tm_polygons(col = "Median_income", palette = "BuGn")
tmap_arrange(col1, col2, col3, col4)
```

tmap also allows for setting breaks using the style argument rather than manual setting breaks. Try out a few of the different style options: "pretty", "equal", "quantile", "jenks", "cont", "cat"

```{r}
tm_shape(nz) + tm_polygons(col = "Median_income", style = "pretty")
```

Palettes define the color range used and can be critical for interpretability of your figures. Palettes can be categorical, sequential, or diverging and each of these serve different purposes. To adjust the palette, you can use the palette argument in tmap.

```{r}
tm_shape(nz) + tm_polygons("Population", palette = "Blues")
tm_shape(nz) + tm_polygons("Population", palette = "YlOrBr")
```

Please reference section 8.2.4 of the online textbook to learn more about good habits for choosing palettes and when it is appropriate to use each.


## Layouts

The map layout refers to the combination of all map elements into a cohesive map. Map elements include among others the objects to be mapped, the title, the scale bar, margins and aspect ratios.

These additional elements can have their own functions for easy layering onto your maps.

```{r}
map_nz + 
  tm_compass(type = "8star", position = c("left", "top")) +
  tm_scale_bar(breaks = c(0, 100, 200), text.size = 1)
```

tm_layout allows for more customization of layout elements

```{r}
layout1 <- map_nz + tm_layout(title = "New Zealand")
layout2 <- map_nz + tm_layout(scale = 5)
layout3 <- map_nz + tm_layout(bg.color = "lightblue")
layout4 <- map_nz + tm_layout(frame = FALSE)
tmap_arrange(layout1, layout2, layout3, layout4)
```

tmap also provides predetermined style options for layout that you can access using the style argument.

```{r}
map_nza + tm_style("bw")
map_nza + tm_style("classic")
map_nza + tm_style("cobalt")
map_nza + tm_style("col_blind")
```

Please reference section 8.2.5 of the online textbook for more information on what you can do to the layout.


## Faceted maps

